<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Filter & Excel Offline PT.JAYA KONTRUKSI</title>

<script src="xlsx.full.min.js"></script>
<style>
body { 
 font-family: 'Courier New', sans-serif;
  width:95%;
  background:#1e1e1e; 
  color:#f1f1f1; 
  padding:0px;
  line-height: 0.9;
}
header {border-radius: 19px;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background: linear-gradient(135deg, #004aad, #001f3f);
  color: #fff;
  text-align: center;
  padding: 12px 0;
  font-size: 18px;
  font-weight: bold;
  letter-spacing: 1px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  z-index: 10;
}

/* ======== ANIMASI & TOMBOL ======== */
h1 {
  font-size: 8px;
  font-weight: 700;
  color: #ffffff;
  letter-spacing: 2px;
  animation: glow 2s ease-in-out infinite alternate;
}

h2 {margin-top;2px;
            font-size: 0.1rem;
            font-weight: 600;
            color: #0dcaf0; /* Warna aksen cyan */
            margin-bottom: 0px;
            /* Animasi Muncul dari Bawah dengan Delay */
            animation: fadeInUp 1s ease-out 0.3s forwards;
            opacity: 0; /* Awalnya tidak terlihat */
        }

/* Teks Versi */
.version {
    font-size: 1rem;
    font-weight: 400;
    color: rgba(255, 255, 255, 0.7);
    /* Animasi Muncul dari Bawah dengan Delay Lebih Lama */
    animation: fadeInUp 1s ease-out 0.6s forwards;
    opacity: 0; /* Awalnya tidak terlihat */
}

/* --- Definisi Keyframe Animasi --- */
@keyframes glow {
    from {
        text-shadow: 0 0 10px #fff, 0 0 20px #0dcaf0;
    }
    to {
        text-shadow: 0 0 20px #0dcaf0, 0 0 40px #00ffff;
    }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.7;
    }
}

/* --- Responsif untuk Perangkat Mobile --- */
@media (max-width: 768px) {
    h1 {
        font-size: 1.2rem;
    }
    h2 {
        font-size: 1.0rem;
    }
    .container {
        padding: 30px 40px;
    }
}

/* ======== MAIN CONTENT SCROLLABLE ======== */
main {
  flex: 1;
  margin-top: 50px;  /* biar gak ketutup header */
  margin-bottom: 80px; /* biar gak ketutup footer */
  padding: 15px;
  overflow-y: auto;
  text-align: center;
}

h2 {
  text-align: center;
  margin-bottom: 12px;
  color: #98a9ff;
  letter-spacing: 1px;
}
.container{display:flex;flex-direction:column;gap:15px; width: 100%;
max-width: 720; margin: 0 auto;}
input,select,button{
  width:100%; 
  padding:10px; 
  margin-top:5px; 
  border-radius:15px; 
  border:3px solid #e95;
  background: #2a2a2a;
  color: #f1f1f1;
  box-sizing: border-box;
}
button{animation: pulse3 3s infinite;
  background:#4caf50; border-radius: 15px;-color: ;
  color:#fff;
  cursor:pointer;
  transition:0.2s;
  font-weight: bold;
}
button:hover{background:#b5a049;}
table{
  border-collapse:collapse;
  width:80%;
  margin-top:15px;
  word-wrap:break-word;
  background: #2a2a2a;
}
th,td{
  border:2px solid #555;
  padding:2px;
  text-align:left;
  font-size:11px;
}
th{
  background:#333;
  font-weight: bold;
}
.kop{
  text-align:center;
  margin-bottom:20px;
  padding: 5px;
}
.kop h3 {
  margin: 0;
  font-size: 20px;
}
.kop p {
  margin: 5px 0 0;
  font-size: 14px;
}
#previewArea{
  overflow-x:auto;
  margin-top: 20px;
}
.total-status {
  text-align: left;
  margin-top: 15px;
  font-weight: bold;
  font-size: 17px;
  background: #2a2a2a;
  padding: 5px;
  border-radius: 19px;
}
.total-status h4 {
  margin-top: 0;
  color: #4caf50;
}
.total-status p {
  margin: 5px 0;
}
.status-badge {
  display: inline-block;
  padding: 2px 5px;
  border-radius: 19px;
  font-size: 10px;
  font-weight: bold;
}
.status-hadir { background-color: #4caf50; color: white; }
.status-izin { background-color: #2196F3; color: white; }
.status-sakit { background-color: #FF9800; color: white; }
.status-telat { background-color: #f44336; color: white; }
.status-lainnya { background-color: #9E9E9E; color: white; }
.time-badge {
  display: inline-block;
  padding: 2px 5px;
  border-radius: 9px;
  font-size: 10px;
  font-weight: bold;
}
.time-oke { background-color: #4caf50; color: white; }
.time-telat { background-color: #f44336; color: white; }

@media(max-width:600px){
  th,td{font-size:12px;padding:5px;}
  .container{padding: 5px;}
}

/* ======== FOOTER FIXED ======== */
/* === FOOTER STABIL DI BAWAH & RAPI === */
footer {border-radius: 15px;
  position: fixed;             /* Nempel di layar */
  bottom: 0;                   /* Di bagian paling bawah */
  left: 0;
  width: 100%;                 /* Sepanjang layar */
  background: rgba(0, 0, 0, 0.5); /* Sedikit transparan biar elegan */
  backdrop-filter: blur(3px);  /* Efek kaca buram */
  text-align: center;
  padding: 6px 0;
  border-top: 1px solid rgba(255,255,255,0.3);
  z-index: 999;
}

/* --- Gaya untuk Paragraf di dalam Footer --- */
footer p {
  margin: 2px 0;
  font-size: 0.75rem;
  color: #aaa;
  font-weight: normal;
}

/* --- Khusus untuk teks tebal (misal: Indonesia) --- */
footer p b {
  font-weight: 900;
  color: #fff;
}

/* --- Efek Berkilau (Shimmer) untuk Link Siwaras Project --- */
footer span {
  cursor: pointer;
  position: relative;
  color: #00d5d5;
  transition: color 0.3s ease;
  background: linear-gradient(
      90deg,
      rgba(255, 255, 255, 0) 0%,
      rgba(255, 255, 255, 0.5) 50%,
      rgba(255, 255, 255, 0) 100%
  );
  background-size: 200% auto;
  background-clip: text;
  -webkit-background-clip: text;
  animation: shimmer 3s linear infinite;
}

/* --- Animasi kilau --- */
@keyframes shimmer {
  to {
    background-position: 200% center;
  }
}

/* --- Saat di-hover --- */
footer span:hover {
  color: #0fffff;
  animation-play-state: paused;
  text-shadow: 0 0 10px rgba(255,255,255,0.7);
}

/* ======== TOMBOL HOME TENGAH BAWAH ======== */
.home-btn {
  display: inline-block;
  margin-top: 15px;
  padding: 12px 20px;
  font-size: 1rem;
  font-weight: bold;
  color: #fff;
  text-decoration: none;
  background: linear-gradient(135deg, #004aad, #ffd700);
  border-radius: 25px;
  border: 2px solid #fff;
  box-shadow: 0 0 8px rgba(255,255,255,0.4);
  transition: all 0.3s ease;
}

.home-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 0 15px rgba(255,215,0,0.6);
}
</style>
</head>
<body>
<header>
    <h1>PT.JAYA KONSTRUKSI</h1> </header>
    <main>
    <p class="lead"><b>Jakarta</b><p> üáÆüá© Indonesia üáÆüá©.</p><p style="font-style: italic;"><h2>Filter Data Master Absensi QR Excel </h2>
</p>
 
<p class="lead"><small>Filter data Per Divisi/Nama/bulan</p><p><small>Pilih file data master di file manajer, pilih data yang akan di filter Divisi/Nama/Bulan .</small></p>
<div class="container">
  <input type="file" id="upload" accept=".xlsx">
  <select id="classFilter"><option value="">--Pilih Divisi--</option></select>
  <select id="nameFilter"><option value="">--Pilih Nama--</option></select>
  <select id="monthFilter">
    <option value="">--Pilih Bulan--</option>
    <option value="01">Januari</option><option value="02">Februari</option>
    <option value="03">Maret</option><option value="04">April</option>
    <option value="05">Mei</option><option value="06">Juni</option>
    <option value="07">Juli</option><option value="08">Agustus</option>
    <option value="09">September</option><option value="10">Oktober</option>
    <option value="11">November</option><option value="12">Desember</option>
  </select>
  <button id="previewBtn">Preview</button>
  <button id="downloadExcel">Download Excel</button>
  <div id="previewArea"></div>
   <!-- Tombol Home di bawah tombol terakhir -->
   <a href="index.html" class="home-btn" title="Kembali ke Home">üè†</a>
</div>
</main>
<footer>
  <p>
    <span onclick="window.open('https://siwarasproject.blogspot.com','_blank')">
      ¬© 2025 Siwaras Project
    </span>
  </p>
 <p><b> üáÆüá© Indonesia üáÆüá©</b></p>
</footer>

<script>
let globalData = [];
const upload = document.getElementById('upload');
const classFilter = document.getElementById('classFilter');
const nameFilter = document.getElementById('nameFilter');
const monthFilter = document.getElementById('monthFilter');

const previewBtn = document.getElementById('previewBtn');

const downloadExcelBtn = document.getElementById('downloadExcel');
const previewArea = document.getElementById('previewArea');

upload.addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(event) {
    try {
      const data = new Uint8Array(event.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const firstSheet = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheet];
      globalData = XLSX.utils.sheet_to_json(worksheet);
      populateFilters();
    } catch (error) {
      alert('Error reading file: ' + error.message);
    }
  };
  reader.readAsArrayBuffer(file);
});

function populateFilters() {
  const classes = [...new Set(globalData.map(d => d.Divisi).filter(Boolean))];
  classFilter.innerHTML = '<option value="">--Pilih Divisi--</option>';
  classes.forEach(c => classFilter.appendChild(new Option(c, c)));
  
  const names = [...new Set(globalData.map(d => d.Nama).filter(Boolean))];
  nameFilter.innerHTML = '<option value="">--Pilih Nama--</option>';
  names.forEach(n => nameFilter.appendChild(new Option(n, n)));
}

function getMonthFromDate(dateStr) {
  if (!dateStr) return '';
  if (dateStr.includes('-')) {
    return dateStr.split('-')[1];
  } else if (dateStr.includes('/')) {
    return dateStr.split('/')[1];
  }
  return '';
}

/**
 * Fungsi untuk memeriksa apakah waktu telat
 * @param {string} timeStr - String waktu, misal "07:15" atau "7:30:00"
 * @returns {boolean} - True jika telat, false jika tidak
 */
function isTimeLate(timeStr) {
  if (!timeStr) return false;
  const parts = timeStr.split(':');
  if (parts.length < 2) return false;
  
  const hour = parseInt(parts[0], 10);
  const minute = parseInt(parts[1], 10);

  if (isNaN(hour) || isNaN(minute)) return false;

  // Jika jam lebih dari 7, atau jam sama dengan 7 tapi menit lebih dari 0, maka telat
  if (hour > 7 || (hour === 7 && minute > 0)) {
    return true;
  }
  return false;
}

/**
 * Memproses data untuk menambahkan kolom 'Time' dengan status "Telat" atau "Oke"
 * @param {Array} data - Array data yang akan diproses
 * @returns {Array} - Array data yang sudah diproses
 */
function processDataWithTimeCheck(data) {
  return data.map(d => {
    // Buat salinan objek untuk menghindari perubahan data asli
    const newData = { ...d };
    
    // Periksa apakah waktu telat
    const isLate = isTimeLate(d.Jam);
    
    // Set nilai kolom Time berdasarkan pemeriksaan waktu
    // Status asli tidak diubah
    newData.Time = isLate ? 'Telat' : 'Oke';
    
    return newData;
  });
}

/**
 * Menghitung total status dari data yang sudah diproses
 * Status "Telat" dihitung dari kolom "Time"
 * Status lainnya dihitung dari kolom "Status"
 * @param {Array} data - Array data yang akan diproses
 * @returns {Object} - Objek berisi total status
 */
function countStatusByType(data) {
  const statusCount = {
    'Hadir': 0,
    'Izin': 0,
    'Sakit': 0,
    'Telat': 0,  // Akan dihitung dari kolom Time
    'Lainnya': 0
  };
  
  data.forEach(d => {
    // Hitung status dari kolom Status
    if (d.Status) {
      const status = d.Status.toString().toLowerCase();
      if (status.includes('hadir')) {
        statusCount['Hadir']++;
      } else if (status.includes('izin')) {
        statusCount['Izin']++;
      } else if (status.includes('sakit')) {
        statusCount['Sakit']++;
      } else if (status.includes('telat')) {
        // Jika ada status telat di kolom Status, tetap hitung
        statusCount['Telat']++;
      } else {
        statusCount['Lainnya']++;
      }
    }
    
    // Hitung telat dari kolom Time
    if (d.Time && d.Time.toString().toLowerCase() === 'telat') {
      statusCount['Telat']++;
    }
  });
  
  return statusCount;
}

function getStatusBadge(status) {
  if (!status) return '';
  const statusLower = status.toString().toLowerCase();
  
  if (statusLower.includes('hadir')) {
    return `<span class="status-badge status-hadir">${status}</span>`;
  } else if (statusLower.includes('izin')) {
    return `<span class="status-badge status-izin">${status}</span>`;
  } else if (statusLower.includes('sakit')) {
    return `<span class="status-badge status-sakit">${status}</span>`;
  } else if (statusLower.includes('telat')) {
    return `<span class="status-badge status-telat">${status}</span>`;
  } else {
    return `<span class="status-badge status-lainnya">${status}</span>`;
  }
}

function getTimeBadge(time) {
  if (!time) return '';
  const timeLower = time.toString().toLowerCase();
  
  if (timeLower.includes('telat')) {
    return `<span class="time-badge time-telat">${time}</span>`;
  } else if (timeLower.includes('oke')) {
    return `<span class="time-badge time-oke">${time}</span>`;
  }
  return time;
}

function previewData() {
  const filtered = globalData.filter(d => {
    const classMatch = classFilter.value ? d.Divisi == classFilter.value : true;
    const nameMatch = nameFilter.value ? d.Nama == nameFilter.value : true;
    const monthMatch = monthFilter.value ? getMonthFromDate(d.Tanggal) == monthFilter.value : true;
    return classMatch && nameMatch && monthMatch;
  });
  
  if (filtered.length == 0) {
    previewArea.innerHTML = '<p>Tidak ada data.</p>';
    return;
  }

  // PROSES DATA SEBELUM DITAMPILKAN
  const processedData = processDataWithTimeCheck(filtered);
  const statusCount = countStatusByType(processedData);
  
  let html = '<div class="kop"><h3>PT.JAYA KONSTRUKSI</h3><p>Slipi Jaya, Jakarta Barat , Indonesia</p></div>';
  // TAMBAHKAN KOLOM "Time" DI HEADER
  html += '<table><tr><th>Nama</th><th>Divisi</th><th>Status</th><th>Tanggal</th><th>Jam</th><th>Time</th></tr>';
  
  processedData.forEach(d => {
    html += `<tr>
      <td>${d.Nama || ''}</td>
      <td>${d.Divisi || ''}</td>
      <td>${getStatusBadge(d.Status)}</td>
      <td>${d.Tanggal || ''}</td>
      <td>${d.Jam || ''}</td>
      <td>${getTimeBadge(d.Time)}</td> <!-- TAMBAHKAN DATA KOLOM TIME DENGAN BADGE -->
    </tr>`;
  });
  
  html += '</table>';
  
  html += '<div class="total-status">';
  html += '<h4>Total Status:</h4>';
  html += `<p>Hadir: ${statusCount['Hadir']}</p>`;
  html += `<p>Izin: ${statusCount['Izin']}</p>`;
  html += `<p>Sakit: ${statusCount['Sakit']}</p>`;
  html += `<p>Telat: ${statusCount['Telat']}</p>`;
  if (statusCount['Lainnya'] > 0) {
    html += `<p>Lainnya: ${statusCount['Lainnya']}</p>`;
  }
  html += `<p><strong>Total Data: ${processedData.length}</strong></p>`;
  html += '</div>';
  
  previewArea.innerHTML = html;
}

previewBtn.addEventListener('click', previewData);

downloadExcelBtn.addEventListener('click', () => {
  if (globalData.length === 0) {
    alert('Silakan upload file terlebih dahulu!');
    return;
  }

  const filtered = globalData.filter(d => {
    const classMatch = classFilter.value ? d.Divisi == classFilter.value : true;
    const nameMatch = nameFilter.value ? d.Nama == nameFilter.value : true;
    const monthMatch = monthFilter.value ? getMonthFromDate(d.Tanggal) == monthFilter.value : true;
    return classMatch && nameMatch && monthMatch;
  });

  if (filtered.length == 0) {
    alert('Tidak ada data untuk diunduh! Lakukan preview terlebih dahulu.');
    return;
  }

  // PROSES DATA SEBELUM DIEKSPOR KE EXCEL
  const processedData = processDataWithTimeCheck(filtered);
  const statusCount = countStatusByType(processedData);

  let ws_data = [];

  ws_data.push(['PT.JAYA KONSTRUKSI']);
  ws_data.push(['Slipi Jaya,Jakarta Barat, Indonesia']);
  ws_data.push(['']);
  // TAMBAHKAN KOLOM "Time" DI HEADER EXCEL
  ws_data.push(['Nama', 'Divisi', 'Status', 'Tanggal', 'Jam', 'Time']);

  processedData.forEach(d => {
    ws_data.push([
      d.Nama || '',
      d.Divisi || '',
      d.Status || '',
      d.Tanggal || '',
      d.Jam || '',
      d.Time || '' // TAMBAHKAN DATA KOLOM TIME
    ]);
  });

  ws_data.push(['']);
  ws_data.push(['TOTAL STATUS']);
  ws_data.push(['Hadir', statusCount['Hadir']]);
  ws_data.push(['Izin', statusCount['Izin']]);
  ws_data.push(['Sakit', statusCount['Sakit']]);
  ws_data.push(['Telat', statusCount['Telat']]);
  if (statusCount['Lainnya'] > 0) {
    ws_data.push(['Lainnya', statusCount['Lainnya']]);
  }
  ws_data.push(['TOTAL DATA', processedData.length]);

  const ws = XLSX.utils.aoa_to_sheet(ws_data);

  // Atur lebar kolom otomatis (termasuk kolom baru)
  const colWidths = [];
  const minWidth = 10; 
  // Header ada di baris ke-3 (index 3), jadi ambil panjang dari sana
  for (let i = 0; i < ws_data[3].length; i++) { 
    let maxCellLength = 0;
    for (let j = 0; j < ws_data.length; j++) {
      const cellValue = ws_data[j][i];
      if (cellValue && typeof cellValue === 'string') {
        maxCellLength = Math.max(maxCellLength, cellValue.length);
      }
    }
    colWidths.push({ wch: Math.max(maxCellLength + 2, minWidth) });
  }
  ws['!cols'] = colWidths;

  // Gabungkan sel untuk header (disesuaikan dengan 6 kolom)
  if (!ws['!merges']) ws['!merges'] = [];
  ws['!merges'].push(XLSX.utils.decode_range('A1:F1')); 
  ws['!merges'].push(XLSX.utils.decode_range('A2:F2')); 
  
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Data_Filter");

  XLSX.writeFile(wb, "Data_Filter.xlsx");
});
</script>
</body>
</html>